<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osho Dhara - Open Audio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            width: 100%;
            padding: 40px 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .app-icon {
            width: 80px;
            height: 80px;
            background: #007AFF;
            border-radius: 18px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.4);
        }
        
        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .playlist-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .playlist-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .track-count {
            font-size: 16px;
            opacity: 0.8;
        }
        
        .buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #007AFF;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056CC;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .status.loading {
            background: rgba(255, 193, 7, 0.2);
            color: #FFC107;
        }
        
        .status.success {
            background: rgba(40, 167, 69, 0.2);
            color: #28A745;
        }
        
        .status.error {
            background: rgba(220, 53, 69, 0.2);
            color: #DC3545;
        }
        
        .footer {
            margin-top: 30px;
            font-size: 12px;
            opacity: 0.6;
        }
        
        @media (max-width: 480px) {
            .container {
                margin: 10px;
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .playlist-name {
                font-size: 18px;
            }
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
            text-align: left;
            display: none;
        }
        
        .debug-toggle {
            margin-top: 10px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-icon">üéµ</div>
        <h1>Osho Dhara</h1>
        
        <div class="playlist-info">
            <div class="playlist-name" id="playlistName">Loading...</div>
            <div class="track-count" id="trackCount"></div>
        </div>
        
        <div class="buttons">
            <a href="#" class="btn btn-primary" id="downloadBtn">
                ‚¨áÔ∏è Download App from App Store
            </a>
            <button class="btn btn-secondary" id="haveAppBtn">
                üîÑ Try Opening App Again
            </button>
            <button class="btn btn-secondary" id="copyLinkBtn">
                üìã Copy Link
            </button>
        </div>
        
        <div class="status" id="status" style="display: none;">
            <!-- Status will be shown when needed -->
        </div>
        
        <div class="debug-toggle" onclick="toggleDebug()">
            üîß Show Debug Info
        </div>
        <div class="debug-info" id="debugInfo">
            <!-- Debug info will be populated by JavaScript -->
        </div>
        
        <div class="footer">
            Share beautiful Osho discourses with friends
        </div>
    </div>

    <script>
        // Debug logging helper
        let debugLogs = [];
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.push(logEntry);
            console.log('üîç [AudioShare] ' + logEntry);
            updateDebugDisplay();
        }
        
        function updateDebugDisplay() {
            const debugElement = document.getElementById('debugInfo');
            debugElement.innerHTML = debugLogs.slice(-10).join('<br>'); // Show last 10 logs
        }
        
        function toggleDebug() {
            const debugElement = document.getElementById('debugInfo');
            const toggle = document.querySelector('.debug-toggle');
            if (debugElement.style.display === 'none' || !debugElement.style.display) {
                debugElement.style.display = 'block';
                toggle.textContent = 'üîß Hide Debug Info';
            } else {
                debugElement.style.display = 'none';
                toggle.textContent = 'üîß Show Debug Info';
            }
        }

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const linkType = urlParams.get('type') || 'group'; // 'group', 'file', or 'audio'
        const playlistName = urlParams.get('name') || 'Playlist';
        const trackCount = urlParams.get('tracks') || '0';
        const groupId = urlParams.get('id') || '';
        const seriesId = urlParams.get('seriesId') || '';
        const audioNumber = urlParams.get('audio') || '';
        
        debugLog(`URL Parameters: type=${linkType}, name=${playlistName}, tracks=${trackCount}, id=${groupId}, seriesId=${seriesId}, audio=${audioNumber}`);
        debugLog(`All URL params: ${Array.from(urlParams.entries()).map(([k, v]) => `${k}=${v}`).join(', ')}`);
        
        let deepLinkURL;
        
        if (linkType === 'audio') {
            debugLog('‚úÖ Detected audio type link');
            
            if (!seriesId || !audioNumber) {
                debugLog('‚ùå Missing seriesId or audioNumber');
                showStatus('Invalid audio link - missing required parameters', 'error');
                showManualOptions();
            } else {
                // Update UI for audio
                document.getElementById('playlistName').textContent = 'Audio Track';
                document.getElementById('trackCount').textContent = `Series: ${seriesId}, Track: ${audioNumber}`;
                
                // Build audio deep link URL
                deepLinkURL = `oshoaudio://open/audio?seriesId=${encodeURIComponent(seriesId)}&audio=${encodeURIComponent(audioNumber)}`;
                debugLog(`‚úÖ Generated audio deep link: ${deepLinkURL}`);
            }
        } else if (linkType === 'file') {
            debugLog('Detected file type link (legacy)');
            const fileName = urlParams.get('name') || '';
            const fileTitle = urlParams.get('title') || '';
            const fileSource = urlParams.get('source') || '';
            const metadata = urlParams.get('metadata') || '';
            
            document.getElementById('playlistName').textContent = decodeURIComponent(fileTitle || fileName);
            document.getElementById('trackCount').textContent = 'Audio track';
            
            let fileParams = `name=${encodeURIComponent(fileName)}&title=${encodeURIComponent(fileTitle || fileName)}&source=${encodeURIComponent(fileSource)}`;
            if (metadata) {
                fileParams += `&metadata=${encodeURIComponent(metadata)}`;
            }
            deepLinkURL = `oshoaudio://open/file?${fileParams}`;
            debugLog(`Generated file deep link: ${deepLinkURL}`);
        } else {
            // Group link (default)
            debugLog('Detected group type link (or default)');
            document.getElementById('playlistName').textContent = decodeURIComponent(playlistName);
            document.getElementById('trackCount').textContent = `${trackCount} audio tracks`;
            
            // Build group deep link URL
            deepLinkURL = `oshoaudio://open/group?name=${encodeURIComponent(playlistName)}&tracks=${trackCount}${groupId ? `&id=${encodeURIComponent(groupId)}` : ''}`;
            debugLog(`Generated group deep link: ${deepLinkURL}`);
        }
        
        // App Store URL for Osho Dhara
        const appStoreURL = 'https://apps.apple.com/app/id6738623487';
        
        // Device detection
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const isMobile = isIOS || isAndroid;
        const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
        
        debugLog(`Device: iOS=${isIOS}, Android=${isAndroid}, Mobile=${isMobile}, Safari=${isSafari}`);
        debugLog(`User Agent: ${navigator.userAgent}`);
        
        // Variables for app detection
        let appInstalled = false;
        let redirectAttempted = false;
        let startTime = 0;
        
        // Function to show status message
        function showStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            debugLog(`Status: ${message} (${type})`);
        }
        
        // Function to hide manual options
        function hideManualOptions() {
            document.querySelector('.buttons').style.display = 'none';
        }
        
        // Function to show manual options
        function showManualOptions() {
            document.querySelector('.buttons').style.display = 'flex';
        }
        
        // Improved app detection using multiple methods
        function attemptAppRedirect() {
            if (!deepLinkURL) {
                debugLog('‚ùå No deep link URL available');
                showStatus('Invalid link format', 'error');
                showManualOptions();
                return;
            }
            
            if (redirectAttempted) {
                debugLog('Redirect already attempted, skipping');
                return;
            }
            
            redirectAttempted = true;
            debugLog('Starting app redirect attempt');
            
            if (linkType === 'audio') {
                showStatus('Opening your audio...', 'loading');
            } else {
                showStatus('Opening your playlist...', 'loading');
            }
            hideManualOptions();
            
            startTime = Date.now();
            
            debugLog(`Attempting to open: ${deepLinkURL}`);
            
            // Create hidden iframe to attempt app opening
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = deepLinkURL;
            document.body.appendChild(iframe);
            
            // Set up app detection logic
            const appDetectionTimeout = setTimeout(() => {
                debugLog('App detection timeout - app likely not installed');
                
                if (!appInstalled && !document.hidden) {
                    debugLog('App not detected, redirecting to App Store');
                    showAppStore();
                }
                
                // Clean up iframe
                if (iframe.parentNode) {
                    document.body.removeChild(iframe);
                }
            }, 2500); // 2.5 seconds to detect app
            
            // Detect if app opened successfully
            const checkAppOpened = () => {
                const timeElapsed = Date.now() - startTime;
                
                if (document.hidden || document.visibilityState === 'hidden') {
                    debugLog('App opened successfully (page hidden)');
                    appInstalled = true;
                    clearTimeout(appDetectionTimeout);
                    showStatus('Welcome to Osho Dhara! üéµ', 'success');
                    if (iframe.parentNode) {
                        document.body.removeChild(iframe);
                    }
                    return;
                }
                
                // Check if enough time has passed
                if (timeElapsed > 1000 && !appInstalled) {
                    debugLog('App likely not installed (page still visible after 1s)');
                    clearTimeout(appDetectionTimeout);
                    showAppStore();
                    if (iframe.parentNode) {
                        document.body.removeChild(iframe);
                    }
                }
            };
            
            // Monitor page visibility changes
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && startTime > 0) {
                    debugLog('App opened (visibility change detected)');
                    appInstalled = true;
                    clearTimeout(appDetectionTimeout);
                    
                    // Show success when user returns
                    setTimeout(() => {
                        if (!document.hidden) {
                            showStatus('Welcome back! Enjoy your audio üéµ', 'success');
                        }
                    }, 1000);
                    
                    if (iframe.parentNode) {
                        document.body.removeChild(iframe);
                    }
                }
            });
            
            // Check app opening after short delay
            setTimeout(checkAppOpened, 1200);
        }
        
        function showAppStore() {
            debugLog('Redirecting to App Store');
            showStatus('App not found. Taking you to App Store...', 'loading');
            showManualOptions();
            
            setTimeout(() => {
                try {
                    window.location.href = appStoreURL;
                } catch (error) {
                    debugLog(`Error opening App Store: ${error.message}`);
                    showStatus('Please manually visit the App Store', 'error');
                }
            }, 2000);
        }
        
        // Event handlers
        document.getElementById('downloadBtn').addEventListener('click', (e) => {
            e.preventDefault();
            debugLog('Manual download button clicked');
            showAppStore();
        });
        
        document.getElementById('haveAppBtn').addEventListener('click', (e) => {
            e.preventDefault();
            debugLog('Manual "have app" button clicked');
            redirectAttempted = false; // Reset to allow retry
            attemptAppRedirect();
        });
        
        document.getElementById('copyLinkBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href).then(() => {
                const btn = document.getElementById('copyLinkBtn');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                showStatus('Link copied! Share it with friends.', 'success');
                debugLog('Link copied to clipboard');
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    document.getElementById('status').style.display = 'none';
                }, 3000);
            }).catch((error) => {
                debugLog(`Clipboard error: ${error.message}`);
                showStatus('Copy not supported. Long press the URL to copy manually.', 'error');
            });
        });
        
        // Handle page load
        window.addEventListener('load', () => {
            debugLog('Page loaded');
            
            // For audio links, make sure we have the required parameters
            if (linkType === 'audio') {
                if (!seriesId || !audioNumber) {
                    debugLog('‚ùå Missing required audio parameters');
                    showStatus('Invalid audio link - missing series ID or audio number', 'error');
                    showManualOptions();
                    return;
                }
            }
            
            if (!isMobile) {
                debugLog('Desktop detected - showing manual options');
                showStatus('Please open this link on your mobile device', 'error');
                showManualOptions();
                return;
            }
            
            if (!isIOS) {
                debugLog('Non-iOS mobile detected - showing manual options');
                showStatus('This app is only available for iPhone and iPad', 'error');
                showManualOptions();
                return;
            }
            
            debugLog('iOS device detected - starting auto redirect');
            
            if (linkType === 'audio') {
                showStatus('Preparing to open your audio...', 'loading');
            } else {
                showStatus('Preparing to open your playlist...', 'loading');
            }
            
            // Auto-attempt for iOS users
            setTimeout(() => {
                attemptAppRedirect();
            }, 1000); // Give user a moment to see the page
        });
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            debugLog(`Visibility changed: hidden=${document.hidden}`);
        });
        
        // Handle focus events (additional app detection)
        window.addEventListener('blur', () => {
            if (startTime > 0 && Date.now() - startTime < 3000) {
                debugLog('Window blur detected - app likely opened');
            }
        });
        
        window.addEventListener('focus', () => {
            debugLog('Window focus returned');
        });
        
        debugLog('Smart redirect system initialized');
    </script>
</body>
</html>

